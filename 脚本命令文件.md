# Multimodal Math Pretraining 脚本命令文档

## 环境设置 (使用 UV)

本项目现在使用 UV 作为包管理器，替代了之前的 Conda 环境。

### 安装和设置环境

1. **安装 UV** (如果尚未安装):
```bash
# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

2. **创建虚拟环境**:
```bash
uv venv
source .venv/bin/activate  # Linux/macOS
# 或者在 Windows: .venv\Scripts\activate
```

3. **安装依赖**:
```bash
# 安装项目及其所有生产依赖
uv pip install -e .

# 如果需要开发工具 (测试、代码格式化等)
uv pip install -e ".[dev]"

# 如果需要 CUDA 支持
uv pip install -e ".[cuda]"

# 如果需要开发工具 + CUDA 支持
uv pip install -e ".[dev,cuda]"
```

4. **验证安装**:
```bash
python -c "import torch; print(f'PyTorch version: {torch.__version__}')"
```

## 目录
- [环境设置](#环境设置-使用-uv)
- [推理 - 属性预测](#推理---属性预测)
- [预训练 - 合成数据](#预训练---合成数据)
- [属性预测训练](#属性预测训练)
- [最大输入维度 1 的预训练](#最大输入维度-1-的预训练)
- [最大输入维度 10 的预训练](#最大输入维度-10-的预训练)
- [属性预测示例](#属性预测示例)

---

## 推理 - 属性预测

### NCR 属性预测
```bash
python eval_proppred.py \
  --is_proppred True \
  --property_type ncr \
  --reload_data 'functions,dump/data/ncr/test.prefix,dump/data/ncr/test.prefix,'
```

---

## 预训练 - 合成数据

### 1D 输入观察的合成数据
```bash
python train.py \
  --export_data True \
  --dump_path ./dump \
  --max_input_dimension 1 \
  --n_steps_per_epoch 3125 \
  --max_epoch 1000
```

### 最大 10D 输入观察的合成数据
```bash
python train.py \
  --export_data True \
  --dump_path ./dump \
  --max_input_dimension 10 \
  --n_steps_per_epoch 3125 \
  --max_epoch 1000
```

---

## 属性预测训练

### NCR 属性预测训练
```bash
python train.py \
  --export_data True \
  --is_proppred True \
  --property_type ncr \
  --dump_path ./dump \
  --use_skeleton True \
  --max_input_dimension 1 \
  --n_steps_per_epoch 3125 \
  --max_epoch 1000 \
  --exp_name data \
  --exp_id ncr_exported  # 保存 10K 训练数据用于 NCR 预测任务
```

---

## 最大输入维度 1 的预训练

### 从头开始预训练
```bash
python train.py \
  --loss_type CLIP \
  --normalize_y True \
  --batch_size 256 \
  --dump_path ./dump \
  --max_input_dimension 1 \
  --n_steps_per_epoch 1000 \
  --max_epoch 100000 \
  --exp_name B256 \
  --exp_id run1-1d \
  --lr 4e-5 \
  --latent_dim 512 \
  --save_periodic 10
```

### 加载并继续预训练（基于预训练模型权重）
```bash
python train.py \
  --reload_model ./weights/snip-1d-normalized.pth \
  --loss_type CLIP \
  --batch_size 256 \
  --dump_path ./dump \
  --max_input_dimension 1 \
  --n_steps_per_epoch 1000 \
  --max_epoch 100000 \
  --exp_name B256 \
  --exp_id run1-1d \
  --lr 4e-5 \
  --latent_dim 512 \
  --save_periodic 10
```

---

## 最大输入维度 10 的预训练

### 从头开始预训练
```bash
python train.py \
  --loss_type CLIP \
  --batch_size 256 \
  --dump_path ./dump \
  --max_input_dimension 10 \
  --n_steps_per_epoch 1000 \
  --max_epoch 100000 \
  --exp_name B256 \
  --exp_id run1-10d \
  --lr 4e-5 \
  --latent_dim 512 \
  --save_periodic 10
```

### 加载并继续预训练（基于预训练模型权重）
```bash
python train.py \
  --reload_model ./weights/snip-10dmax.pth \
  --loss_type CLIP \
  --batch_size 256 \
  --dump_path ./dump \
  --max_input_dimension 10 \
  --n_steps_per_epoch 1000 \
  --max_epoch 100000 \
  --exp_name B256 \
  --exp_id run1-10d \
  --lr 4e-5 \
  --latent_dim 512 \
  --save_periodic 10
```

---

## 属性预测示例

### NCR 属性预测

#### 不使用预训练
```bash
python train.py \
  --is_proppred True \
  --property_type ncr \
  --reload_data functions,dump/data/ncr/train.prefix,dump/data/ncr/train.prefix, \
  --normalize_y True \
  --batch_size 16 \
  --dump_path ./dump \
  --max_input_dimension 1 \
  --n_steps_per_epoch 625 \
  --max_epoch 100000 \
  --exp_name NCR_pred \
  --exp_id run1 \
  --lr 1e-5 \
  --latent_dim 512 \
  --save_periodic 10
```

#### 使用预训练 - 冻结编码器
```bash
python train.py \
  --reload_model ./weights/snip-1d-normalized.pth \
  --is_proppred True \
  --property_type ncr \
  --freeze_encoder True \
  --reload_data functions,dump/data/ncr/train.prefix,dump/data/ncr/train.prefix, \
  --normalize_y True \
  --batch_size 16 \
  --dump_path ./dump \
  --max_input_dimension 1 \
  --n_steps_per_epoch 625 \
  --max_epoch 100000 \
  --exp_name NCR_pred \
  --exp_id run1 \
  --lr 1e-5 \
  --latent_dim 512 \
  --save_periodic 10
```

#### 使用预训练 - 微调编码器
```bash
python train.py \
  --reload_model ./weights/snip-1d-normalized.pth \
  --is_proppred True \
  --property_type ncr \
  --freeze_encoder False \
  --reload_data functions,dump/data/ncr/train.prefix,dump/data/ncr/train.prefix, \
  --normalize_y True \
  --batch_size 16 \
  --dump_path ./dump \
  --max_input_dimension 1 \
  --n_steps_per_epoch 625 \
  --max_epoch 100000 \
  --exp_name NCR_pred \
  --exp_id run1 \
  --lr 1e-5 \
  --latent_dim 512 \
  --save_periodic 10
```

#### 计算表达式与数据点对嵌入相似度
```bash
python similarity_calculator.py \
            --eval_only true \
            --tasks functions \
            --eval_from_exp weights/snip-10dmax.pth \
            --eval_data dump/test_data/data.prefix \
            --dump_path ./eval_output \
            --max_input_dimension 10 \
            --max_output_dimension 1 \
            --latent_dim 512
```